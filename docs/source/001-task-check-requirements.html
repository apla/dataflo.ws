<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">var test     = require('utest');
var assert   = require('assert');

var common   = require ('../common');
var workflow = require ('../workflow');

clearInterval (global.currentDateInterval);

var checkTaskParams  = workflow.prototype.checkTaskParams;
var taskRequirements = workflow.prototype.taskRequirements;

var data = {
	boolExp: &quot;{$data.bool}&quot;,
	checkFalse: {
		falseExp: &quot;{$data.no}&quot;,
		zeroExp: &quot;{$data.zero}&quot;,
		emptyExp: &quot;{$data.empty}&quot;,
		emptyArr: &quot;{$data.emptyArr}&quot;,
		emptyObj: &quot;{$data.emptyObj}&quot;
	},
	exception: {
		stringExp2: &quot;{$badString}&quot;,
		nothing: &quot;{$erlkjgnwlekrjgn}&quot;
	},
	stringExp: &quot;{$data.string}&quot;,
	stringExp3: &quot;{$okString}&quot;,
	numberExp: &quot;{$data.number}&quot;,
	inlineExp: &quot;{$data.string}-{$data.number}&quot;,
	arrayExp: &quot;{$arr}&quot;,
	objectExp: &quot;{$data}&quot;,
	arrayExtExp: [&quot;{$data}&quot;, &quot;{$data.number}&quot;]

};

var dict = {
	data: {
		bool: true,
		string: &quot;string&quot;,
		number: 123,
		zero: 0,
		no: false,
		empty: &quot;&quot;,
		emptyArr: [],
		emptyObj: {}
	},
	badString: &quot;{$&quot;,
	okString: &quot;}&quot;,
	arr: ['a', 'b'],
};

test('findInterpolation', {
	'simple': function() {
		var result = common.findInterpolation (data);
		console.log (result);
		assert.deepEqual (result, {
			boolExp: [ 'data.bool' ],
			'checkFalse.falseExp': [ 'data.no' ],
			'checkFalse.zeroExp': [ 'data.zero' ],
			'checkFalse.emptyExp': [ 'data.empty' ],
			'checkFalse.emptyArr': [ 'data.emptyArr' ],
			'checkFalse.emptyObj': [ 'data.emptyObj' ],
			'exception.stringExp2': [ 'badString' ],
			'exception.nothing': [ 'erlkjgnwlekrjgn' ],
			stringExp: [ 'data.string' ],
			stringExp3: [ 'okString' ],
			numberExp: [ 'data.number' ],
			inlineExp: [ 'data.string', 'data.number' ],
			arrayExp: [ 'arr' ],
			objectExp: [ 'data' ],
			'arrayExtExp.0': [ 'data' ],
			'arrayExtExp.1': [ 'data.number' ]
		});
	}
});

test('check task requirements', {
	'expandFailNoThrow': function() {
		var result = checkTaskParams (data, dict);
		console.log (result);
		assert.strictEqual (result.modified.arrayExtExp[1], 123);
		assert.deepEqual (result.failed, [
			&quot;checkFalse.falseExp&quot;,
			&quot;checkFalse.zeroExp&quot;,
			&quot;checkFalse.emptyExp&quot;,
			&quot;checkFalse.emptyArr&quot;,
			&quot;checkFalse.emptyObj&quot;,
			
			&quot;exception.stringExp2&quot;,
			&quot;exception.nothing&quot;
		]);
	}
});


test('compare interpolation', {
	'simple': function() {
		var byTreeWalk = checkTaskParams (data, dict);
//		console.log (result);

		var interpolateWhat  = common.findInterpolation (data);
		var taskWaitingFor   = taskRequirements (interpolateWhat, dict);
		
		// strictly saying string exception below is incorrect
		// because pathToVal is flawed
		assert.deepEqual (taskWaitingFor, [
			'checkFalse.falseExp',
			'checkFalse.zeroExp',
			'checkFalse.emptyExp',
			'checkFalse.emptyArr',
			'checkFalse.emptyObj',
			'exception.nothing'
		]);
		
		console.log (taskWaitingFor);
		
//		var byDirectValueSet = ;

		assert.strictEqual (byTreeWalk.modified.arrayExtExp[1], 123);
		assert.deepEqual (byTreeWalk.failed, [
			&quot;checkFalse.falseExp&quot;,
			&quot;checkFalse.zeroExp&quot;,
			&quot;checkFalse.emptyExp&quot;,
			&quot;checkFalse.emptyArr&quot;,
			&quot;checkFalse.emptyObj&quot;,
			
			&quot;exception.stringExp2&quot;,
			&quot;exception.nothing&quot;
		]);
	}
});


//	'expandString': function() {
//		var result = data.stringExp.interpolate (dict);
//		assert.strictEqual (result, &quot;string&quot;);
//	},
//	'expandString2': function() {
//		assert.throws (function () {
//			var result = data.stringExp2.interpolate (dict);
//		});
//	},
//	'expandString3': function() {
//		var result = data.stringExp3.interpolate (dict);
//		assert.strictEqual (result, &quot;}&quot;);
//	},
//
//	'expandNumber': function() {
//		var result = data.numberExp.interpolate (dict);
//		assert.strictEqual (result, 123);
//	},
//
//	'expandInline': function() {
//		var result = data.inlineExp.interpolate (dict);
//		assert.strictEqual (result, &quot;string-123&quot;);
//	},
//
//	'expandArray': function() {
//		var result = data.arrayExp.interpolate (dict);
//		assert.deepEqual (result, ['a', 'b']);
//	},
//
//	'expandObject': function() {
//		var result = data.objectExp.interpolate (dict);
//		assert.deepEqual (result, {
//			bool: true,
//			string: &quot;string&quot;,
//			number: 123
//		});
//	}
</pre>
</body>
</html>
