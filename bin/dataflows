#!/usr/bin/env node

var path = require('path');
var common = require('dataflo.ws/common');

var initiatorTypes = process.argv.slice(3);

var $global = common.$global;
$global.project = common.getProject(); // used by initiators

project.on('ready', function () {
	var conf = project.config;

	// load local modules
	var requires = conf.requires || ['main'];
	if (requires) {
		if (!Object.is('Array', requires)) {
			requires = [ requires ];
		}
		requires.forEach(function (modName) {
			var mod = project.require(modName);

			// exporting everything to mainModule,
			// be careful about name conflicts
			if (mod) {
				Object.keys(mod).forEach(function (key) {
					$global.$mainModule[key] = mod[key];
				});
			} else {
				console.warn('Module %s not found', modName);
			}
		});
	}

	// initiate all daemons if no arguments passed
	if (0 == initiatorTypes.length) {
		initiatorTypes = Object.keys(conf.initiator);
	}

	initiatorTypes.forEach(function (type) {
		var initiator;
		try {
			initiator = require('dataflo.ws/initiator/' + type);
		} catch (e) {
			var fixedIName = type.match (/(.*)d$/);
			if (fixedIName && fixedIName[1]) try {
				initiator = require('dataflo.ws/initiator/' + fixedIName[1]);
				console.error ('[NOTE] please convert your "'+type+'" initiator configuration to use names without "d" at end');
			} catch (ee) {
				throw e;
			}
		}
		if ('function' == typeof initiator) {
			new initiator(conf.initiator[type]);
		}
	});
});
