#!/usr/bin/env node

var path = require('path');
var common = require('dataflo.ws/common');

var projectRoot = path.resolve(process.argv[2] || process.cwd());
var initiatorTypes = process.argv.slice(3);

var $global = common.$global;
var project = common.getProject(projectRoot);
$global.project = project; // used by initiators

project.on('ready', function () {
	var conf = project.config;

	// load local modules
	var requires = conf.requires;
	if (requires) {
		if (!Object.is('Array', requires)) {
			requires = [ requires ];
		}
		requires.forEach(function (modName) {
			var mod = project.require(modName);

			// exporting everything to mainModule,
			// be careful about name conflicts
			if (mod) {
				Object.keys(mod).forEach(function (key) {
					$global.$mainModule[key] = mod[key];
				});
			} else {
				console.warn('Module %s not found', modName);
			}
		});
	}

	// initiate all daemons if no arguments passed
	if (0 == initiatorTypes.length) {
		initiatorTypes = Object.keys(conf.initiator);
	}

	initiatorTypes.forEach(function (type) {
		var Initiator = require('dataflo.ws/initiator/' + type);
		if ('function' == typeof Initiator) {
			new Initiator(conf.initiator[type]);
		}
	});
});
